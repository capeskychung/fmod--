* 3D声音
    * 介绍
    * 加载声音为“3D”
    * 距离模型和线性下降 vs 反向
        * 反向
        * 距离模型和线性下降
    * 全局3D设置
    * 方向，左手坐标系和右手坐标系
    * 一个典型的游戏循环
    * 立体和多声道的声音可以是三维的!
    * 分割屏幕/多个侦听器
    * 扬声器模式/输出


#### 介绍
本节将向您介绍如何使用FMOD Studio中的3D声音。有了它，您可以轻松实现交互式3D音频，并访问功能，如5.1或7.1扬声器输出，自动衰减，多普勒和更先进的心理声学3D音频技术。

有关特定于FMOD Studio事件的信息，请参见Studio 3D Events页面。

#### 加载声音为“3D”
加载声音或声音库时，必须使用System::createSound或System::createStream使用FMOD_3D标志创建声音。ie。

```
result = system->createSound("../media/drumloop.wav", FMOD_3D, 0, &sound);
if (result != FMOD_OK)
{
    HandleError(result);
}
```

一般最好不要尝试和3d和2d之间切换,不过,如果你想要你可以改变声音或频道的模式在运行时FMOD_3D_HEADRELATIVE哪些地方的声音总是相对于侦听器,有效地探测2 d,因为它总是跟随侦听器,侦听器绕。


#### 距离模型和线性下降 vs 反向
##### 反向
这是默认的FMOD 3D距离模型。在现实世界中，所有的声音都会通过反向距离衰减自然衰减(淡出)。要设置为这种模式的标志是FMOD_3D_INVERSEROLLOFF，但是如果你正在加载一个声音，你不需要设置这个，因为它是默认值。如果稍后将模式设置为FMOD_3D_LINEARROLLOFF，则更适合于将模式重置为原始模式。  

当FMOD使用这个模型时，声音/通道的“mindistance”是声音开始衰减的距离。这可以模拟声音的大小。默认情况下，每增加一倍的最小距离，音量就会减半。可以使用System::set3DSettings更改这个滚动速度。

作为一个相对声音大小的例子，我们可以比较蜜蜂和大型喷气式飞机。离蜜蜂只有一两米远的地方，我们可能再也听不到它的声音了。相比之下，几百米外就能听到喷气式飞机的声音。在这种情况下，我们可以将蜜蜂的最小距离设置为0.1米。几米后，它应该会安静下来。这架大型喷气式飞机的最小航程可以设定为50米。这可能需要数百米的距离之间的听众和声音之间的沉默。在本例中，我们现在对声音的响度有了更真实的表示，即使每个波形文件内部都有一个完全标准化的16位波形。(例如，如果你用2D播放它们，它们的音量都是一样的)。

“最大距离”不影响滚压的速度，它只是意味着声音停止衰减的距离。不要将最大距离设置为一个较低的数字，除非您希望它人为地停止衰减。这通常是不需要的。让它保持默认值10000.0。

##### 距离模型和线性下降
这是FMOD引入的另一种距离模型。通过在System:: createssound或Sound::setMode / ChannelControl::setMode中添加FMOD_3D_LINEARROLLOFF或FMOD_3D_LINEARSQUAREROLLOFF标志来支持它。这是一种比较假的，但通常对游戏程序员比较友好的衰减方法。它允许“mindistance”和“maxdistance”设置将衰减行为更改为两个距离之间的线性衰减。实际上，最小距离与对数方法相同(即声音开始衰减前的最小距离，否则为全音量)，但是由于3D距离的关系，最大距离现在变成了体积= 0的点。这两点之间的衰减是线性的或者线性的平方。

#### 全局3D设置
FMOD Studio中影响所有3D声音的3个主要可配置设置是:
* 多普勒因子。这只是一种夸大或最小化多普勒效应的方法。
* 距离的因素。这允许用户设置FMOD使用与自己匹配的单位(例如厘米、米、英尺)
* 滚边的规模。影响使用FMOD_3D_LOGROLLOFF的3d声音。使用此模式控制所有声音衰减的速度。

所有3个设置都可以通过System::set3DSettings来设置。通常，用户不想设置这些。

速度和保持帧速率无关
只有当你想要多普勒效应时才需要速度。否则，可以将0或NULL传递给System::set3DListenerAttributes和ChannelControl::set3DAttributes作为速度参数，并且不会听到多普勒效应。

这一点必须再次强调。重要的是传递到FMOD Studio的速度是米每秒，而不是米每帧。注意到差别。要得到正确的速度矢量，使用物理代码中的矢量等等，不要只是用当前位置减去最后一帧的位置。这受到帧率的影响。帧率越高，位置增量越小，因此多普勒效应也就越小，这是不正确的。

如果你能得到速度的唯一方法是减去这个和最后一帧的位置向量，然后记住时间把它们从每帧米调整到每秒米。这是简单地通过缩放差向量得到的通过减去2个位置向量，除以帧时间增量。

例子：

```
velx = (posx-lastposx) * 1000 / timedelta;
velz = (posy-lastposy) * 1000 / timedelta;
velz = (posz-lastposz) * 1000 / timedelta;
```

时间增量是距离最后一帧的时间(以毫秒为单位)。这可以通过timeGetTime()等函数获得。所以在60fps时，时间是16.67毫秒。如果源在这段时间内移动0.1米，实际速度(米/秒)为:


```
vel = 0.1 * 1000 / 16.67 = 6 meters per second.
```

类似地，如果我们只有30fps帧率的一半，那么减去位置增量将得到60fps时距离的两倍(所以这次移动了0.2米)。

```
vel = 0.2 * 1000 / 33.33 = 6 meters per second.
```

#### 方向，左手坐标系和右手坐标系
如果你想让源在三维空间中移动，设置正确的方向是非常重要的。 

默认情况下，FMOD使用左手坐标系。如果使用右手坐标系，则必须通过将fmod_init_3d_right - to system::init传递给fmod_init_3d_right - to - system::init来初始化FMOD。在这两种情况下，FMOD都要求正Y轴向上，正X轴是对的，如果你的坐标系使用了不同的约定，那么你必须在将向量传递到FMOD之前将它们旋转到FMOD的空间中。

插件作者注意:FMOD在向插件传递3D数据时总是使用左手坐标系。这个坐标系固定为+X = right +Y = up +Z = forward。当系统初始化为使用右手坐标时，FMOD将翻转矢量的Z分量，然后将其传递给插件。


#### 一个典型的游戏循环
3D音效和FMOD通道管理系统每帧需要更新一次。要做到这一点，请使用System::update。
这将是一个游戏音频循环的典型例子。

```
do
{ 
    UpdateGame();       // here the game is updated and the sources would be moved with channel->set3DAttibutes.

    system->set3DListenerAttributes(0, &listener_pos, &listener_vel, &listener_forward, &listener_up);     // update 'ears'

    system->update();   // needed to update 3d engine, once per frame.

} while (gamerunning);
```

大多数游戏通常从相机的矢量和矩阵中获取位置、速度和方向。



#### 立体和多声道的声音可以是三维的!
一个立体的声音，当播放为3d，将分为两个单声道内部是单独的3d定位。多声道声音也支持，所以一个8声道的声音，例如将分配8个单声道内部在FMOD。要在三维空间中旋转立体三维声音的左右部分，可以使用ChannelControl::set3DSpread函数。默认情况下，子通道将自己定位在相同的位置，因此听起来是“mono”。

#### 分割屏幕/多个侦听器
在一些游戏中，可能会有分屏模式。当谈到音频时，这意味着FMOD Studio必须知道屏幕上同时有多个侦听器。这很容易通过System:: set3dnumlistener和System::set3DListenerAttributes来处理。 

如果您有2个播放器分割屏幕，那么对于每个“camera”或“listener”，只需调用System::set3DListenerAttributes，其中第一个camera的侦听器号为0，第二个camera的侦听器号为1。系统:set3dnumlistener将被设置为2。


使用核心时，3D通道有以下行为:
* 它关闭了所有多普勒。这是因为一个听众可能会走向声音，而另一个听众可能会远离声音。为了避免混淆，多普勒被简单地关闭。
* 所有音频均为单声道。如果对一个听众来说，声音应该是从左边的扬声器发出来的，而对另一个听众来说，声音应该是从右边的扬声器发出来的，那么就会产生冲突，产生更多的混乱，所以所有的声音都被移到中间。这消除了困惑。
* 每个声音只播放一次，就像在单人游戏中一样，节省了语音和cpu资源。这意味着声音的有效可听性是由离声音最近的听者决定的。这是有道理的，因为对于最近的听众来说，声音应该是最大的。此时，任何较远的侦听器都不会对音量产生任何影响。

#### 扬声器模式/输出
得到5.1的声音很容易。如果声卡支持它,然后使用FMOD_3D任何声音将自动定位在一个环绕扬声器系统,只有用户必须确保扬声器设置在操作系统中是正确的,这样声音设备可以在5.1或7.1音频输出。您不需要为FMOD设置扬声器模式。
